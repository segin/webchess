<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Play chess online with friends in real-time. WebChess offers multiplayer chess games, practice mode, and AI opponents. No registration required.">
    <title>WebChess - Online Chess Game</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ôî</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <script>
        // Cache busting for CSS
        const cssLink = document.querySelector('link[href="styles.css"]');
        if (cssLink) {
            cssLink.href = 'styles.css?v=' + Date.now();
        }
    </script>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div class="container">
        <header role="banner">
            <h1 id="main-heading">WebChess</h1>
            <p>Two-Player Online Chess</p>
        </header>

        <main role="main" id="main-content">
            <!-- Loading Screen -->
            <div id="loading-screen" class="screen" role="status" aria-live="polite">
                <div class="loading-content">
                    <h2>Loading WebChess...</h2>
                    <div class="loading-spinner" aria-hidden="true" role="img" aria-label="Loading spinner"></div>
                    <p id="loading-status">Initializing game engine...</p>
                </div>
            </div>

            <!-- Main Menu -->
            <div id="main-menu" class="screen hidden">
                <nav class="menu-buttons" role="navigation" aria-label="Main menu options">
                    <div id="resume-section" class="resume-section hidden">
                        <button id="resume-btn" class="btn btn-success" aria-label="Resume your active chess game">Resume Game</button>
                        <p id="resume-info" class="resume-info">Return to your active game</p>
                    </div>
                    <button id="host-btn" class="btn btn-primary" aria-label="Host a new chess game">Host Game</button>
                    <button id="join-btn" class="btn btn-primary" aria-label="Join an existing chess game">Join Game</button>
                    <button id="practice-btn" class="btn btn-secondary" aria-label="Start practice mode">Practice</button>
                    <button id="run-tests-btn" class="btn btn-warning" aria-label="Run test suite">üß™ Run Tests</button>
                </nav>
            </div>

            <!-- Host Game Screen -->
            <div id="host-screen" class="screen hidden">
                <h2>Host Game</h2>
                <div class="game-info" role="status" aria-live="polite">
                    <p>Share this Game ID with your opponent:</p>
                    <div id="game-id-display" class="game-id-large" role="text" aria-label="Game ID for sharing"></div>
                    <p class="status">Waiting for opponent to join...</p>
                </div>
                <button id="cancel-host-btn" class="btn btn-secondary" aria-label="Cancel hosting game">Cancel</button>
            </div>

            <!-- Join Game Screen -->
            <div id="join-screen" class="screen hidden">
                <h2 id="join-screen-title">Join Game</h2>
                <form class="join-form" role="form" aria-labelledby="join-screen-title" novalidate>
                    <fieldset>
                        <legend class="sr-only">Game ID Entry</legend>
                        <label for="game-id-input">Enter Game ID:</label>
                        <input type="text" id="game-id-input" placeholder="Enter 6-character game ID" maxlength="6" aria-describedby="game-id-help" aria-required="true" autocomplete="off" spellcheck="false" pattern="[A-Za-z0-9]{6}" title="Game ID must be exactly 6 characters">
                        <div id="game-id-help" class="sr-only">Enter the 6-character game ID provided by your opponent</div>
                        <button id="join-game-btn" class="btn btn-primary" aria-label="Join game with entered ID" type="button">Join Game</button>
                    </fieldset>
                </form>
                <button id="cancel-join-btn" class="btn btn-secondary" aria-label="Return to main menu">Back to Menu</button>
                <div id="join-error" class="error-message hidden" role="alert" aria-live="assertive" aria-atomic="true" tabindex="-1"></div>
            </div>

            <!-- Practice Mode Selection Screen -->
            <div id="practice-screen" class="screen hidden">
                <h2>Practice Mode</h2>
                <div class="practice-options">
                    <div class="practice-option" role="group" aria-labelledby="practice-self-btn">
                        <button id="practice-self-btn" class="btn btn-primary" aria-describedby="practice-self-desc">Play Both Sides</button>
                        <p id="practice-self-desc">Control both white and black pieces</p>
                    </div>
                    <div class="practice-option" role="group" aria-labelledby="practice-ai-white-btn">
                        <button id="practice-ai-white-btn" class="btn btn-primary" aria-describedby="practice-white-desc">Play as White vs AI</button>
                        <p id="practice-white-desc">You play white, AI plays black</p>
                    </div>
                    <div class="practice-option" role="group" aria-labelledby="practice-ai-black-btn">
                        <button id="practice-ai-black-btn" class="btn btn-primary" aria-describedby="practice-black-desc">Play as Black vs AI</button>
                        <p id="practice-black-desc">You play black, AI plays white</p>
                    </div>
                    <div class="practice-option" role="group" aria-labelledby="practice-ai-vs-ai-btn">
                        <button id="practice-ai-vs-ai-btn" class="btn btn-secondary" aria-describedby="practice-ai-desc">Watch AI vs AI</button>
                        <p id="practice-ai-desc">Watch two AI players compete</p>
                    </div>
                </div>
                <div class="ai-difficulty" role="group" aria-labelledby="difficulty-label">
                    <label id="difficulty-label" for="difficulty-select">AI Difficulty:</label>
                    <select id="difficulty-select" aria-label="Select AI difficulty level" aria-describedby="difficulty-help">
                        <option value="easy">Easy</option>
                        <option value="medium" selected>Medium</option>
                        <option value="hard">Hard</option>
                        <option value="expert">Expert (Slow)</option>
                    </select>
                    <div id="difficulty-help" class="sr-only">Choose the AI opponent difficulty level for practice games</div>
                </div>
                <button id="cancel-practice-btn" class="btn btn-secondary" aria-label="Return to main menu">Back to Menu</button>
            </div>

            <!-- Game Board Screen -->
            <div id="game-screen" class="screen hidden">
                <div class="game-header">
                    <div class="game-info">
                        <span id="game-id-small" role="text" aria-label="Current game ID"></span>
                        <span id="player-color" role="text" aria-label="Your piece color"></span>
                    </div>
                    <div class="game-status" role="status" aria-live="assertive" aria-atomic="true">
                        <span id="turn-indicator" aria-label="Current turn indicator"></span>
                        <span id="check-indicator" class="hidden" role="alert" aria-live="assertive">CHECK!</span>
                        <div id="game-status-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>
                    </div>
                    <div class="game-actions">
                        <button id="resign-btn" class="btn btn-danger" aria-label="Resign from current game">Resign</button>
                        <button id="leave-game-btn" class="btn btn-secondary" aria-label="Leave current game">Leave Game</button>
                        <button id="debug-dump-btn" class="btn btn-warning" aria-label="Show debug information">üêõ Debug</button>
                        <button id="mobile-chat-toggle" class="btn btn-info mobile-only hidden" aria-label="Toggle chat window">Chat</button>
                        <button id="fullscreen-btn" class="btn btn-secondary mobile-only" aria-label="Toggle fullscreen mode">‚õ∂</button>
                        <div id="ai-controls" class="ai-controls hidden" role="group" aria-label="AI game controls">
                            <button id="pause-ai-btn" class="btn btn-warning" aria-label="Pause AI moves" aria-pressed="false">Pause</button>
                            <button id="step-ai-btn" class="btn btn-info" aria-label="Make AI move one step">Step</button>
                        </div>
                    </div>
                </div>

                <div class="game-content">
                    <div class="chess-board-container">
                        <div id="chess-board" class="chess-board" role="grid" aria-label="Chess board with 8x8 squares" tabindex="0" aria-describedby="board-help">
                            <div id="board-help" class="sr-only">Use arrow keys to navigate the chess board. Press Enter to select a piece or make a move.</div>
                        </div>
                    </div>
                    
                    <div class="game-sidebar">
                        <div class="move-history">
                            <h3>Move History</h3>
                            <div id="move-list" class="move-list" role="log" aria-label="Game move history" aria-live="polite"></div>
                        </div>
                        
                        <div class="connection-status">
                            <div id="connection-indicator" class="connection-indicator connected" role="status" aria-live="polite" aria-label="Connection status">
                                <span class="indicator-dot" aria-hidden="true" role="img" aria-label="Connection status indicator"></span>
                                <span class="indicator-text">Connected</span>
                            </div>
                        </div>
                        
                        <div id="chat-section" class="chat-section hidden">
                            <h3>Chat</h3>
                            <div id="chat-messages" class="chat-messages" role="log" aria-label="Chat messages" aria-live="polite"></div>
                            <div class="chat-input">
                                <label for="chat-input" class="sr-only">Chat message</label>
                                <input type="text" id="chat-input" placeholder="Type a message..." maxlength="200" aria-label="Type chat message">
                                <button id="send-chat-btn" class="btn btn-sm" aria-label="Send chat message">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile Chat Overlay -->
            <div id="mobile-chat-overlay" class="mobile-chat-overlay hidden">
                <div class="mobile-chat-card">
                    <div class="mobile-chat-header">
                        <h3>Chat</h3>
                        <button id="mobile-chat-close" class="btn btn-sm btn-secondary" aria-label="Close chat">√ó</button>
                    </div>
                    <div id="mobile-chat-messages" class="mobile-chat-messages" role="log" aria-label="Mobile chat messages" aria-live="polite"></div>
                    <div class="mobile-chat-input">
                        <label for="mobile-chat-input" class="sr-only">Mobile chat message</label>
                        <input type="text" id="mobile-chat-input" placeholder="Type a message..." maxlength="200" aria-label="Type mobile chat message">
                        <button id="mobile-send-chat-btn" class="btn btn-sm btn-primary" aria-label="Send mobile chat message">Send</button>
                    </div>
                </div>
            </div>

            <!-- Game End Screen -->
            <div id="game-end-screen" class="modal hidden">
                <div class="game-end-content modal-content" role="dialog" aria-labelledby="game-end-title" aria-modal="true">
                    <h2 id="game-end-title">Game Over</h2>
                    <p id="game-end-message" role="status"></p>
                    <div class="game-end-actions">
                        <button id="new-game-btn" class="btn btn-primary" aria-label="Start a new game">New Game</button>
                        <button id="back-to-menu-btn" class="btn btn-secondary" aria-label="Return to main menu">Back to Menu</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Pawn Promotion Modal -->
        <div id="promotion-modal" class="modal hidden" role="dialog" aria-labelledby="promotion-title" aria-modal="true" aria-describedby="promotion-desc">
            <div class="modal-content">
                <h3 id="promotion-title">Pawn Promotion</h3>
                <p id="promotion-desc">Choose a piece to promote your pawn:</p>
                <div class="promotion-pieces" role="radiogroup" aria-label="Promotion piece selection" aria-required="true">
                    <button class="promotion-piece" data-piece="queen" aria-label="Promote to Queen" role="radio" aria-checked="false" tabindex="0">‚ôï</button>
                    <button class="promotion-piece" data-piece="rook" aria-label="Promote to Rook" role="radio" aria-checked="false" tabindex="-1">‚ôñ</button>
                    <button class="promotion-piece" data-piece="bishop" aria-label="Promote to Bishop" role="radio" aria-checked="false" tabindex="-1">‚ôó</button>
                    <button class="promotion-piece" data-piece="knight" aria-label="Promote to Knight" role="radio" aria-checked="false" tabindex="-1">‚ôò</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Cache busting for main script
        const scriptElement = document.createElement('script');
        scriptElement.src = 'script.js?v=' + Date.now();
        let webChessInitialized = false;
        
        function updateLoadingStatus(message) {
            const statusElement = document.getElementById('loading-status');
            if (statusElement) {
                statusElement.textContent = message;
            }
            console.log('Loading:', message);
        }
        
        function showMainMenu() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
            console.log('WebChess fully loaded and ready!');
        }
        
        function initializeWebChess() {
            if (webChessInitialized) return;
            
            updateLoadingStatus('Checking game components...');
            console.log('Attempting to initialize WebChess...');
            console.log('WebChessClient type:', typeof WebChessClient);
            console.log('ChessAI type:', typeof ChessAI);
            
            if (typeof WebChessClient === 'function' && typeof ChessAI === 'function') {
                updateLoadingStatus('Starting game client...');
                try {
                    webChessInitialized = true;
                    new WebChessClient();
                    updateLoadingStatus('Loading complete!');
                    setTimeout(showMainMenu, 500); // Brief delay to show completion
                } catch (error) {
                    console.error('Error initializing WebChessClient:', error);
                    updateLoadingStatus('Error loading game. Please refresh.');
                }
            } else {
                updateLoadingStatus('Loading game engine...');
                setTimeout(initializeWebChess, 200);
            }
        }
        
        scriptElement.onload = () => {
            console.log('script.js loaded successfully');
            updateLoadingStatus('Script loaded, initializing...');
            // Wait for DOM to be ready, then initialize
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeWebChess);
            } else {
                initializeWebChess();
            }
        };
        scriptElement.onerror = (e) => console.error('Failed to load script.js:', e);
        document.head.appendChild(scriptElement);
        
        // Global error handling
        window.addEventListener('error', (e) => {
            console.error('JavaScript Error:', e.filename, e.lineno, e.error);
        });
        
        // Initialize loading status
        updateLoadingStatus('Loading scripts...');
        
        // Test runner functionality - load only when needed
        document.addEventListener('DOMContentLoaded', () => {
            const testBtn = document.getElementById('run-tests-btn');
            if (testBtn) {
                testBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Open test runner in new window/tab
                    window.open('/test-runner.html', '_blank');
                });
            }
        });
    </script>
</body>
</html>